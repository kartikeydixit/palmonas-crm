name: palmonas-crm

services:
  mongo:
    image: mongo:7
    container_name: palmonas-mongo
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME:-root}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-rootpassword}
    volumes:
      - mongo_data:/data/db
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "mongosh --quiet \"mongodb://$$MONGO_INITDB_ROOT_USERNAME:$$MONGO_INITDB_ROOT_PASSWORD@localhost:27017/admin\" --eval \"db.runCommand({ ping: 1 }).ok\" | grep -q 1"
        ]
      interval: 5s
      timeout: 5s
      retries: 20

  redis:
    image: redis:7-alpine
    container_name: palmonas-redis
    ports:
      - "6379:6379"
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 30

  mock-channels:
    build:
      context: ./mock-channels
    container_name: palmonas-mock-channels
    ports:
      - "4010:4010"
    environment:
      NODE_ENV: production
      PORT: 4010
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:4010/healthz').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))"]
      interval: 5s
      timeout: 5s
      retries: 30

  api:
    build:
      context: ./backend
    container_name: palmonas-api
    depends_on:
      mongo:
        condition: service_healthy
      redis:
        condition: service_healthy
      mock-channels:
        condition: service_healthy
    ports:
      - "4000:4000"
    environment:
      NODE_ENV: production
      PORT: 4000
      LOG_LEVEL: info
      MONGO_URI: mongodb://${MONGO_ROOT_USERNAME:-root}:${MONGO_ROOT_PASSWORD:-rootpassword}@mongo:27017/palmonas?authSource=admin
      REDIS_URL: redis://redis:6379
      CHANNELS_BASE_URL: http://mock-channels:4010
      JWT_ACCESS_SECRET: ${JWT_ACCESS_SECRET}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET}
      JWT_ACCESS_TTL_SECONDS: ${JWT_ACCESS_TTL_SECONDS:-900}
      JWT_REFRESH_TTL_SECONDS: ${JWT_REFRESH_TTL_SECONDS:-604800}
      FEATURE_FLAGS: ${FEATURE_FLAGS:-}
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:5173}
      RATE_LIMIT_MAX: ${RATE_LIMIT_MAX:-300}
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:4000/healthz').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))"]
      interval: 5s
      timeout: 5s
      retries: 30

  worker:
    build:
      context: ./worker
    container_name: palmonas-worker
    depends_on:
      mongo:
        condition: service_healthy
      redis:
        condition: service_healthy
      mock-channels:
        condition: service_healthy
    environment:
      NODE_ENV: production
      LOG_LEVEL: info
      MONGO_URI: mongodb://${MONGO_ROOT_USERNAME:-root}:${MONGO_ROOT_PASSWORD:-rootpassword}@mongo:27017/palmonas?authSource=admin
      REDIS_URL: redis://redis:6379
      REDIS_HOST: redis
      CHANNELS_BASE_URL: http://mock-channels:4010
      FEATURE_FLAGS: ${FEATURE_FLAGS:-}
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:4020/healthz').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))"]
      interval: 10s
      timeout: 5s
      retries: 30
    ports:
      - "4020:4020"

  frontend:
    build:
      context: ./frontend
    container_name: palmonas-frontend
    depends_on:
      api:
        condition: service_healthy
    ports:
      - "5173:5173"
    environment:
      NODE_ENV: production
      VITE_API_BASE_URL: http://localhost:4000

volumes:
  mongo_data:
  redis_data:

